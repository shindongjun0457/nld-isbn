<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ISBN ì„œì§€ì •ë³´ ì¡°íšŒ (êµ­ë¦½ì¤‘ì•™ë„ì„œê´€)</title>
  <style>
    :root{
      --primary:#4f46e5;
      --primary-hover:#4338ca;
      --bg:#f8fafc;
      --card-bg:#ffffff;
      --text-main:#1e293b;
      --text-muted:#64748b;
      --border:#e2e8f0;
      --soft:#f1f5f9;
      --danger:#b00020;
    }

    *{box-sizing:border-box;margin:0;padding:0;}

    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans KR",sans-serif;
      background:var(--bg);
      color:var(--text-main);
      min-height:100vh;
      padding:20px;
    }

    /* ì˜¤ë¥¸ìª½ ìœ„ ë„êµ¬ ë²„íŠ¼ */
    .top-right{
      position:fixed;
      top:16px;
      right:16px;
      z-index:100;
    }
    .top-right a{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:10px 14px;
  border-radius:999px;
  text-decoration:none;
  font-size:0.9rem;
  font-weight:800;

  /* âœ… íŒŒë€ìƒ‰ ê°•ì¡° */
  background: var(--primary);
  color: #ffffff;
  border: 1px solid var(--primary);

  box-shadow: 0 6px 14px rgba(79,70,229,0.35);
  transition: background-color .2s, transform .1s, box-shadow .2s;
}

.top-right a:hover{
  background: var(--primary-hover);
  box-shadow: 0 8px 18px rgba(67,56,202,0.45);
}

.top-right a:active{
  transform: scale(.97);
}


    .container{
      background:var(--card-bg);
      width:100%;
      max-width:980px;
      margin:0 auto;
      padding:2rem;
      border-radius:1rem;
      box-shadow:0 10px 25px -5px rgba(0,0,0,0.1),0 8px 10px -6px rgba(0,0,0,0.1);
    }

    header{
      margin-bottom:1.5rem;
      text-align:center;
    }

    h1{
      font-size:1.6rem;
      font-weight:800;
      margin-bottom:.5rem;
      letter-spacing:-0.02em;
    }

    .sub{
      font-size:.9rem;
      color:var(--text-muted);
      line-height:1.5;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
      margin-top:18px;
    }

    .input-group label{
      display:block;
      font-size:0.875rem;
      font-weight:700;
      margin-bottom:8px;
    }

    textarea{
      width:100%;
      height:180px;
      padding:1rem;
      border:1px solid var(--border);
      border-radius:.75rem;
      font-size:1rem;
      line-height:1.5;
      resize:vertical;
      outline:none;
      transition:border-color .2s, box-shadow .2s;
      background:#fff;
    }
    textarea:focus{
      border-color:var(--primary);
      box-shadow:0 0 0 3px rgba(79,70,229,0.15);
    }

    .controls{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin-top:12px;
    }

    .btn{
      border:none;
      border-radius:.75rem;
      padding:.75rem 1rem;
      font-size:1rem;
      font-weight:700;
      cursor:pointer;
      transition:background-color .2s, transform .1s, opacity .2s;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .btn:active{transform:scale(.98);}
    .btn:disabled{opacity:.55;cursor:not-allowed;}

    .btn-primary{background:var(--primary);color:#fff;}
    .btn-primary:hover{background:var(--primary-hover);}

    .btn-ghost{
      background:#fff;
      color:var(--text-main);
      border:1px solid var(--border);
    }
    .btn-ghost:hover{
      background:var(--soft);
      border-color:#cbd5e1;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      font-size:.85rem;
      color:var(--text-muted);
      font-weight:700;
    }

    .warn{
      color:var(--danger);
      font-size:.85rem;
      font-weight:700;
    }

    .summary{
      margin-top:14px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
    }

    .table-wrap{
      margin-top:16px;
      background:#fff;
      border:1px solid var(--border);
      border-radius:1rem;
      overflow:hidden;
    }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:.9rem;
    }

    thead th{
      position:sticky;
      top:0;
      background:var(--soft);
      border-bottom:1px solid var(--border);
      padding:12px 10px;
      text-align:left;
      font-size:.8rem;
      letter-spacing:.02em;
      text-transform:uppercase;
      color:#475569;
      z-index:1;
    }

    tbody td{
      border-bottom:1px solid var(--border);
      padding:10px;
      vertical-align:top;
      word-break:break-word;
    }

    tbody tr:hover td{
      background:#fafafa;
    }

    .footer{
      margin-top:12px;
      color:var(--text-muted);
      font-size:.8rem;
      text-align:center;
      line-height:1.5;
    }

    /* ì‘ì€ í™”ë©´ ëŒ€ì‘ */
    @media (max-width: 720px){
      .container{padding:1.25rem;}
      textarea{height:160px;}
      .btn{width:100%;}
      .pill{width:100%;justify-content:center;}
      .top-right{top:12px;right:12px;}
    }
  </style>
</head>
<body>

  <!-- ì˜¤ë¥¸ìª½ ìœ„: ë‚˜ì´ìŠ¤ ì…ë ¥ì–‘ì‹ ë³€í™˜ê¸° -->
  <div class="top-right">
    <a
    href="/tools/book-list-converter.html"
    target="_blank"
    rel="noopener noreferrer"
    title="ë‚˜ì´ìŠ¤ ì…ë ¥ì–‘ì‹ ë³€í™˜ê¸°"
  >
    ë‚˜ì´ìŠ¤ ì…ë ¥ì–‘ì‹ ë³€í™˜ê¸°
  </a>
  </div>

  <div class="container">
    <header>
      <h1>ğŸ“š ISBN ì„œì§€ì •ë³´ ì¡°íšŒ</h1>
      <div class="sub">
        ISBNì„ ì¤„ë°”ê¿ˆìœ¼ë¡œ ì—¬ëŸ¬ ê°œ ì…ë ¥í•˜ë©´, êµ­ë¦½ì¤‘ì•™ë„ì„œê´€ ì„œì§€ì •ë³´ APIë¡œ ë„ì„œ ì •ë³´ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.<br/>
        í•œ ë²ˆì— ìµœëŒ€ <b>500ê°œ</b>ê¹Œì§€ ì²˜ë¦¬ë©ë‹ˆë‹¤.
      </div>
    </header>

    <div class="grid">
      <div class="input-group">
        <label for="input">ISBN ì…ë ¥ (í•œ ì¤„ì— í•˜ë‚˜)</label>
        <textarea id="input" placeholder="ì˜ˆ)
9788972598435
9791189799908
..."></textarea>

        <div class="controls">
          <button id="btnLookup" class="btn btn-primary">ì¡°íšŒ</button>
          <button id="btnRetryNotFound" class="btn btn-ghost" disabled>ë¯¸ê²€ìƒ‰ë§Œ ì¬ì¡°íšŒ</button>
          <button id="btnDownload" class="btn btn-ghost" disabled>ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
          <button id="btnClear" class="btn btn-ghost">ì´ˆê¸°í™”</button>

          <span class="pill" id="countBadge">0ê°œ</span>
          <span class="pill" id="progressBadge">ëŒ€ê¸°</span>
          <span class="warn" id="warnText"></span>
        </div>

        <div class="summary" id="summary"></div>
        <div class="sub" id="detail" style="margin-top:8px;"></div>
      </div>

      <div class="table-wrap" style="max-height: 60vh; overflow:auto;">
        <table id="table">
          <thead>
            <tr>
              <th>isbn</th>
              <th>ë„ì„œëª…</th>
              <th>ì €ìëª…</th>
              <th>ë„ì„œëª…(ì €ìëª…)</th>
              <th>ì¶œíŒì‚¬</th>
              <th>ë°œí–‰ë…„ë„</th>
              <th>ì¡°íšŒê²°ê³¼</th>
              <th>ë¹„ê³ </th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="footer">
        Â© 2025. ì˜¤í˜„ì¤‘í•™êµ. All rights reserved.

      </div>
    </div>
  </div>

  <!-- SheetJS (xlsx) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    // ====== ì„¤ì • ======
    let API_ENDPOINT = "https://nld-isbn-lookup.djshin0457.workers.dev/api/isbn";

    const MAX_ISBNS = 500;
    const CHUNK_SIZE = 25;
    const CHUNK_TIMEOUT_MS = 20000;

    const elInput = document.getElementById("input");
    const elCount = document.getElementById("countBadge");
    const elProgress = document.getElementById("progressBadge");
    const elWarn = document.getElementById("warnText");
    const elSummary = document.getElementById("summary");
    const elDetail = document.getElementById("detail");
    const elTbody = document.querySelector("#table tbody");
    const btnLookup = document.getElementById("btnLookup");
    const btnRetryNotFound = document.getElementById("btnRetryNotFound");
    const btnDownload = document.getElementById("btnDownload");
    const btnClear = document.getElementById("btnClear");

    let lastResults = [];
    let isRunning = false;

    function parseIsbns(text) {
      return text
        .split(/\s+|,/g)
        .map(s => s.trim())
        .filter(Boolean);
    }

    function updateCount() {
      const list = parseIsbns(elInput.value);
      elCount.textContent = `${list.length}ê°œ`;
      elWarn.textContent = list.length > MAX_ISBNS
        ? `${MAX_ISBNS}ê°œë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. ì•ì˜ ${MAX_ISBNS}ê°œë§Œ ì²˜ë¦¬ë©ë‹ˆë‹¤. (í˜„ì¬ ${list.length}ê°œ)`
        : "";
    }

    elInput.addEventListener("input", updateCount);
    updateCount();

    function renderTable(rows) {
      elTbody.innerHTML = "";
      const frag = document.createDocumentFragment();
      const cols = ["isbn","ë„ì„œëª…","ì €ìëª…","ë„ì„œëª…(ì €ìëª…)","ì¶œíŒì‚¬","ë°œí–‰ë…„ë„","ì¡°íšŒê²°ê³¼","ë¹„ê³ "];
      for (const r of rows) {
        const tr = document.createElement("tr");
        for (const c of cols) {
          const td = document.createElement("td");
          td.textContent = r?.[c] ?? "";
          tr.appendChild(td);
        }
        frag.appendChild(tr);
      }
      elTbody.appendChild(frag);
    }

    function renderSummary(summary) {
      if (!summary) { elSummary.innerHTML = ""; return; }
      elSummary.innerHTML = `
        <span class="pill">ì´ ${summary.total}ê±´</span>
        <span class="pill">ì„±ê³µ ${summary.success}</span>
        <span class="pill">ë¯¸ê²€ìƒ‰ ${summary.notFound}</span>
        <span class="pill">ì‹¤íŒ¨ ${summary.failed}</span>
        <span class="pill">í˜•ì‹ì˜¤ë¥˜ ${summary.invalid}</span>
      `;
    }

    function addSummary(a, b) {
      return {
        total: (a.total ?? 0) + (b.total ?? 0),
        success: (a.success ?? 0) + (b.success ?? 0),
        notFound: (a.notFound ?? 0) + (b.notFound ?? 0),
        failed: (a.failed ?? 0) + (b.failed ?? 0),
        invalid: (a.invalid ?? 0) + (b.invalid ?? 0),
      };
    }

    function makeFailRow(isbn, reason) {
      return {
        isbn: isbn ?? "",
        "ë„ì„œëª…": "",
        "ì €ìëª…": "",
        "ë„ì„œëª…(ì €ìëª…)": "",
        "ì¶œíŒì‚¬": "",
        "ë°œí–‰ë…„ë„": "",
        "ì¡°íšŒê²°ê³¼": "ì‹¤íŒ¨",
        "ë¹„ê³ ": reason ?? "",
      };
    }

    async function fetchWithTimeout(url, options = {}, timeoutMs = CHUNK_TIMEOUT_MS) {
      const controller = new AbortController();
      const id = setTimeout(() => controller.abort(), timeoutMs);
      try {
        return await fetch(url, { ...options, signal: controller.signal });
      } finally {
        clearTimeout(id);
      }
    }

    async function readJsonSafely(res) {
      const text = await res.text();
      if (!text) return { ok: false, error: `ë¹ˆ ì‘ë‹µ(HTTP ${res.status})` };
      try {
        return JSON.parse(text);
      } catch {
        return { ok: false, error: `JSON ì•„ë‹˜(HTTP ${res.status}): ${text.slice(0, 200)}` };
      }
    }

    function chunkArray(arr, size) {
      const chunks = [];
      for (let i = 0; i < arr.length; i += size) {
        chunks.push(arr.slice(i, i + size));
      }
      return chunks;
    }

    function enableRetryButton() {
      btnRetryNotFound.disabled = !lastResults.some(r => r["ì¡°íšŒê²°ê³¼"] === "ë¯¸ê²€ìƒ‰");
    }

    btnLookup.addEventListener("click", async () => {
      if (isRunning) return;

      const all = parseIsbns(elInput.value).slice(0, MAX_ISBNS);
      if (all.length === 0) return;

      const chunks = chunkArray(all, CHUNK_SIZE);

      isRunning = true;
      btnLookup.disabled = true;
      btnRetryNotFound.disabled = true;
      btnDownload.disabled = true;
      btnClear.disabled = true;

      elProgress.textContent = "ì¡°íšŒ ì¤€ë¹„...";
      elDetail.textContent = "";
      renderTable([]);
      renderSummary(null);

      lastResults = [];
      let runningSummary = { total: 0, success: 0, notFound: 0, failed: 0, invalid: 0 };
      let doneCount = 0;

      try {
        for (let ci = 0; ci < chunks.length; ci++) {
          const chunk = chunks[ci];
          elProgress.textContent = `ì¡°íšŒ ì¤‘... (${ci + 1}/${chunks.length})`;
          elDetail.textContent = `ì§„í–‰: ${doneCount}/${all.length} ì²˜ë¦¬ë¨`;

          let res;
          try {
            res = await fetchWithTimeout(
              API_ENDPOINT,
              {
                method: "POST",
                headers: { "content-type": "application/json" },
                body: JSON.stringify({ isbns: chunk })
              },
              CHUNK_TIMEOUT_MS
            );
          } catch (e) {
            const reason = `ìš”ì²­ ì‹œê°„ ì´ˆê³¼/ì—°ê²° ì‹¤íŒ¨: ${String(e?.name || e).slice(0, 80)}`;
            lastResults = lastResults.concat(chunk.map(isbn => makeFailRow(isbn, reason)));
            runningSummary = addSummary(runningSummary, {
              total: chunk.length, success: 0, notFound: 0, failed: chunk.length, invalid: 0
            });
            doneCount += chunk.length;
            renderTable(lastResults);
            renderSummary(runningSummary);
            continue;
          }

          const data = await readJsonSafely(res);

          if (!res.ok || !data?.ok) {
            const reason = `ì„œë²„ ì˜¤ë¥˜: ${data?.error || `HTTP ${res.status}`}`;
            lastResults = lastResults.concat(chunk.map(isbn => makeFailRow(isbn, reason)));
            runningSummary = addSummary(runningSummary, {
              total: chunk.length, success: 0, notFound: 0, failed: chunk.length, invalid: 0
            });
            doneCount += chunk.length;
            renderTable(lastResults);
            renderSummary(runningSummary);
            continue;
          }

          const rows = Array.isArray(data.results) ? data.results : [];
          lastResults = lastResults.concat(rows);

          if (data.summary) {
            runningSummary = addSummary(runningSummary, data.summary);
          } else {
            const s = {
              total: rows.length,
              success: rows.filter(r => r["ì¡°íšŒê²°ê³¼"] === "ì„±ê³µ").length,
              notFound: rows.filter(r => r["ì¡°íšŒê²°ê³¼"] === "ë¯¸ê²€ìƒ‰").length,
              failed: rows.filter(r => r["ì¡°íšŒê²°ê³¼"] === "ì‹¤íŒ¨").length,
              invalid: rows.filter(r => r["ì¡°íšŒê²°ê³¼"] === "í˜•ì‹ì˜¤ë¥˜").length,
            };
            runningSummary = addSummary(runningSummary, s);
          }

          doneCount += chunk.length;
          renderTable(lastResults);
          renderSummary(runningSummary);
        }

        elProgress.textContent = "ì™„ë£Œ";
        elDetail.textContent = `ì™„ë£Œ: ${doneCount}/${all.length} ì²˜ë¦¬ë¨`;

        btnDownload.disabled = lastResults.length === 0;
        enableRetryButton();
      } catch (e) {
        elProgress.textContent = "ì˜¤ë¥˜";
        alert(`ì¡°íšŒ ì‹¤íŒ¨: ${e?.message || e}`);
      } finally {
        isRunning = false;
        btnLookup.disabled = false;
        btnClear.disabled = false;
        btnDownload.disabled = lastResults.length === 0;
      }
    });

    btnRetryNotFound.addEventListener("click", async () => {
      if (isRunning) return;

      const targets = [];
      lastResults.forEach((row, index) => {
        if (row["ì¡°íšŒê²°ê³¼"] === "ë¯¸ê²€ìƒ‰") {
          targets.push({ isbn: row.isbn, index });
        }
      });

      if (targets.length === 0) {
        alert("ë¯¸ê²€ìƒ‰ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.");
        btnRetryNotFound.disabled = true;
        return;
      }

      isRunning = true;
      btnLookup.disabled = true;
      btnRetryNotFound.disabled = true;
      btnDownload.disabled = true;
      btnClear.disabled = true;

      const retryIsbns = targets.map(t => t.isbn);
      const chunks = chunkArray(retryIsbns, CHUNK_SIZE);

      let processed = 0;

      try {
        for (let ci = 0; ci < chunks.length; ci++) {
          elProgress.textContent = `ë¯¸ê²€ìƒ‰ ì¬ì¡°íšŒ ì¤‘... (${processed}/${targets.length})`;
          elDetail.textContent = `ë¯¸ê²€ìƒ‰ ì¬ì¡°íšŒ ì§„í–‰: ${processed}/${targets.length}`;

          let res;
          try {
            res = await fetchWithTimeout(
              API_ENDPOINT,
              {
                method: "POST",
                headers: { "content-type": "application/json" },
                body: JSON.stringify({ isbns: chunks[ci] })
              },
              CHUNK_TIMEOUT_MS
            );
          } catch {
            processed += chunks[ci].length;
            continue;
          }

          const data = await readJsonSafely(res);
          if (!res.ok || !data?.ok || !Array.isArray(data.results)) {
            processed += chunks[ci].length;
            continue;
          }

          data.results.forEach(newRow => {
            const t = targets.find(
              x => x.isbn === newRow.isbn && lastResults[x.index]["ì¡°íšŒê²°ê³¼"] === "ë¯¸ê²€ìƒ‰"
            );
            if (!t) return;
            lastResults[t.index] = newRow;
          });

          processed += chunks[ci].length;
          renderTable(lastResults);
        }

        elProgress.textContent = "ë¯¸ê²€ìƒ‰ ì¬ì¡°íšŒ ì™„ë£Œ";
        elDetail.textContent = `ë¯¸ê²€ìƒ‰ ì¬ì¡°íšŒ ì™„ë£Œ: ${targets.length}ê±´`;

        btnDownload.disabled = lastResults.length === 0;
        enableRetryButton();
      } finally {
        isRunning = false;
        btnLookup.disabled = false;
        btnClear.disabled = false;
        btnDownload.disabled = lastResults.length === 0;
      }
    });

    btnDownload.addEventListener("click", () => {
      if (!lastResults || lastResults.length === 0) return;

      const cols = ["isbn","ë„ì„œëª…","ì €ìëª…","ë„ì„œëª…(ì €ìëª…)","ì¶œíŒì‚¬","ë°œí–‰ë…„ë„","ì¡°íšŒê²°ê³¼","ë¹„ê³ "];
      const rows = lastResults.map(r => {
        const o = {};
        for (const c of cols) o[c] = r?.[c] ?? "";
        return o;
      });

      const ws = XLSX.utils.json_to_sheet(rows, { header: cols });
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "ê²°ê³¼");

      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, "0");
      const dd = String(today.getDate()).padStart(2, "0");
      XLSX.writeFile(wb, `isbn_ë„ì„œëª©ë¡_${yyyy}-${mm}-${dd}.xlsx`);
    });

    btnClear.addEventListener("click", () => {
      if (isRunning) return;
      elInput.value = "";
      updateCount();
      lastResults = [];
      renderTable([]);
      renderSummary(null);
      elDetail.textContent = "";
      btnDownload.disabled = true;
      btnRetryNotFound.disabled = true;
      elProgress.textContent = "ëŒ€ê¸°";
    });
  </script>
</body>
</html>
