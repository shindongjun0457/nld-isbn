<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ISBN ì„œì§€ì •ë³´ ì¡°íšŒ (êµ­ë¦½ì¤‘ì•™ë„ì„œê´€)</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif; margin: 24px; }
    h1 { margin: 0 0 12px; font-size: 20px; }
    .help { color: #444; margin-bottom: 12px; line-height: 1.5; }
    textarea { width: 100%; height: 180px; padding: 10px; box-sizing: border-box; }
    .row { display: flex; gap: 8px; align-items: center; margin: 10px 0 16px; flex-wrap: wrap; }
    button { padding: 8px 12px; cursor: pointer; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .badge { padding: 6px 10px; border: 1px solid #ccc; border-radius: 999px; }
    .warn { color: #b00020; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { border: 1px solid #ddd; padding: 8px; vertical-align: top; font-size: 13px; }
    th { background: #f6f6f6; text-align: left; position: sticky; top: 0; }
    .footer { margin-top: 10px; color: #666; font-size: 12px; }
    .muted { color:#666; font-size:12px; }
  </style>
</head>
<body>
  <h1>ISBN ì„œì§€ì •ë³´ ì¡°íšŒ</h1>
  <div class="help">
    ISBNì„ ì¤„ë°”ê¿ˆìœ¼ë¡œ ì—¬ëŸ¬ ê°œ ì…ë ¥í•˜ì„¸ìš”. <b>í•œ ë²ˆì— ìµœëŒ€ 500ê°œ</b>ê¹Œì§€ ì²˜ë¦¬ë©ë‹ˆë‹¤.<br />
    ëŒ€ëŸ‰ ì¡°íšŒ ì•ˆì •í™”ë¥¼ ìœ„í•´ <b>25ê°œì”© ë¶„í• </b>í•´ ìˆœì°¨ ì¡°íšŒí•©ë‹ˆë‹¤.
  </div>

  <textarea id="input" placeholder="ì˜ˆ)
9788972598435
9791189799908
..."></textarea>

  <div class="row">
    <button id="btnLookup">ì¡°íšŒ</button>
    <button id="btnRetryNotFound" disabled>ë¯¸ê²€ìƒ‰ë§Œ ì¬ì¡°íšŒ</button>
    <button id="btnDownload" disabled>ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
    <button id="btnClear">ì´ˆê¸°í™”</button>
    <span class="badge" id="countBadge">0ê°œ</span>
    <span class="badge" id="progressBadge">ëŒ€ê¸°</span>
    <span class="warn" id="warnText"></span>
  </div>

  <div id="summary"></div>
  <div class="muted" id="detail"></div>

  <div style="overflow:auto; max-height: 60vh;">
    <table id="table">
      <thead>
        <tr>
          <th>isbn</th>
          <th>ë„ì„œëª…</th>
          <th>ì €ìëª…</th>
          <th>ë„ì„œëª…(ì €ìëª…)</th>
          <th>ì¶œíŒì‚¬</th>
          <th>ë°œí–‰ë…„ë„</th>
          <th>ì¡°íšŒê²°ê³¼</th>
          <th>ë¹„ê³ </th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="footer">
    ë°±ì—”ë“œ(Worker)ì—ì„œë§Œ êµ­ë¦½ì¤‘ì•™ë„ì„œê´€ APIë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤. í”„ë¡ íŠ¸ì—ëŠ” ì¸ì¦í‚¤ê°€ í¬í•¨ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
  </div>

  <!-- SheetJS (xlsx) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    // ====== ì„¤ì • ======
    // ë°°í¬ëœ Worker APIë¡œ ê³ ì • (í•„ìš” ì‹œ ë³¸ì¸ URLë¡œ ë³€ê²½)
    let API_ENDPOINT = "https://nld-isbn-lookup.djshin0457.workers.dev/api/isbn";

    // ëŒ€ëŸ‰ ì¡°íšŒ ì•ˆì •í™” íŒŒë¼ë¯¸í„°
    const MAX_ISBNS = 500;
    const CHUNK_SIZE = 25;          // 25ê°œì”© ë¶„í•  í˜¸ì¶œ
    const CHUNK_TIMEOUT_MS = 20000; // ê° chunk ìš”ì²­ 20ì´ˆ ì œí•œ (ë©ˆì¶¤ ë°©ì§€)

    const elInput = document.getElementById("input");
    const elCount = document.getElementById("countBadge");
    const elProgress = document.getElementById("progressBadge");
    const elWarn = document.getElementById("warnText");
    const elSummary = document.getElementById("summary");
    const elDetail = document.getElementById("detail");
    const elTbody = document.querySelector("#table tbody");
    const btnLookup = document.getElementById("btnLookup");
    const btnRetryNotFound = document.getElementById("btnRetryNotFound");
    const btnDownload = document.getElementById("btnDownload");
    const btnClear = document.getElementById("btnClear");

    let lastResults = [];
    let isRunning = false;

    function parseIsbns(text) {
      // ì¤„ë°”ê¿ˆ/ì‰¼í‘œ/ê³µë°± í˜¼í•© í—ˆìš©
      return text
        .split(/\s+|,/g)
        .map(s => s.trim())
        .filter(Boolean);
    }

    function updateCount() {
      const list = parseIsbns(elInput.value);
      elCount.textContent = `${list.length}ê°œ`;
      elWarn.textContent = list.length > MAX_ISBNS
        ? `${MAX_ISBNS}ê°œë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. ì•ì˜ ${MAX_ISBNS}ê°œë§Œ ì²˜ë¦¬ë©ë‹ˆë‹¤. (í˜„ì¬ ${list.length}ê°œ)`
        : "";
    }

    elInput.addEventListener("input", updateCount);
    updateCount();

    function renderTable(rows) {
      elTbody.innerHTML = "";
      const frag = document.createDocumentFragment();
      const cols = ["isbn","ë„ì„œëª…","ì €ìëª…","ë„ì„œëª…(ì €ìëª…)","ì¶œíŒì‚¬","ë°œí–‰ë…„ë„","ì¡°íšŒê²°ê³¼","ë¹„ê³ "];
      for (const r of rows) {
        const tr = document.createElement("tr");
        for (const c of cols) {
          const td = document.createElement("td");
          td.textContent = r?.[c] ?? "";
          tr.appendChild(td);
        }
        frag.appendChild(tr);
      }
      elTbody.appendChild(frag);
    }

    function renderSummary(summary) {
      if (!summary) { elSummary.innerHTML = ""; return; }
      elSummary.innerHTML = `
        <div class="row" style="margin: 0 0 8px;">
          <span class="badge">ì´ ${summary.total}ê±´</span>
          <span class="badge">ì„±ê³µ ${summary.success}</span>
          <span class="badge">ë¯¸ê²€ìƒ‰ ${summary.notFound}</span>
          <span class="badge">ì‹¤íŒ¨ ${summary.failed}</span>
          <span class="badge">í˜•ì‹ì˜¤ë¥˜ ${summary.invalid}</span>
        </div>
      `;
    }

    function addSummary(a, b) {
      return {
        total: (a.total ?? 0) + (b.total ?? 0),
        success: (a.success ?? 0) + (b.success ?? 0),
        notFound: (a.notFound ?? 0) + (b.notFound ?? 0),
        failed: (a.failed ?? 0) + (b.failed ?? 0),
        invalid: (a.invalid ?? 0) + (b.invalid ?? 0),
      };
    }

    function makeFailRow(isbn, reason) {
      return {
        isbn: isbn ?? "",
        "ë„ì„œëª…": "",
        "ì €ìëª…": "",
        "ë„ì„œëª…(ì €ìëª…)": "",
        "ì¶œíŒì‚¬": "",
        "ë°œí–‰ë…„ë„": "",
        "ì¡°íšŒê²°ê³¼": "ì‹¤íŒ¨",
        "ë¹„ê³ ": reason ?? "",
      };
    }

    // âœ… ë©ˆì¶¤ ë°©ì§€: fetch ìì²´ íƒ€ì„ì•„ì›ƒ
    async function fetchWithTimeout(url, options = {}, timeoutMs = CHUNK_TIMEOUT_MS) {
      const controller = new AbortController();
      const id = setTimeout(() => controller.abort(), timeoutMs);
      try {
        return await fetch(url, { ...options, signal: controller.signal });
      } finally {
        clearTimeout(id);
      }
    }

    // âœ… JSONì´ ì•„ë‹ ë•Œë„ ì›ì¸ í™•ì¸ ê°€ëŠ¥
    async function readJsonSafely(res) {
      const text = await res.text();
      if (!text) return { ok: false, error: `ë¹ˆ ì‘ë‹µ(HTTP ${res.status})` };
      try {
        return JSON.parse(text);
      } catch {
        return { ok: false, error: `JSON ì•„ë‹˜(HTTP ${res.status}): ${text.slice(0, 200)}` };
      }
    }

    function chunkArray(arr, size) {
      const chunks = [];
      for (let i = 0; i < arr.length; i += size) {
        chunks.push(arr.slice(i, i + size));
      }
      return chunks;
    }

    function enableRetryButton() {
      btnRetryNotFound.disabled = !lastResults.some(r => r["ì¡°íšŒê²°ê³¼"] === "ë¯¸ê²€ìƒ‰");
    }

    btnLookup.addEventListener("click", async () => {
      if (isRunning) return;

      const all = parseIsbns(elInput.value).slice(0, MAX_ISBNS);
      if (all.length === 0) return;

      const chunks = chunkArray(all, CHUNK_SIZE);

      // UI ì´ˆê¸°í™”
      isRunning = true;
      btnLookup.disabled = true;
      btnRetryNotFound.disabled = true;
      btnDownload.disabled = true;
      btnClear.disabled = true;
      elProgress.textContent = "ì¡°íšŒ ì¤€ë¹„...";
      elDetail.textContent = "";
      renderTable([]);
      renderSummary(null);

      lastResults = [];
      let runningSummary = { total: 0, success: 0, notFound: 0, failed: 0, invalid: 0 };
      let doneCount = 0;

      try {
        for (let ci = 0; ci < chunks.length; ci++) {
          const chunk = chunks[ci];
          elProgress.textContent = `ì¡°íšŒ ì¤‘... (${ci + 1}/${chunks.length})`;
          elDetail.textContent = `ì§„í–‰: ${doneCount}/${all.length} ì²˜ë¦¬ë¨`;

          // âœ… ê° chunk ìš”ì²­ì€ íƒ€ì„ì•„ì›ƒì´ ê±¸ë¦¼ (ë©ˆì¶¤ ë°©ì§€)
          let res;
          try {
            res = await fetchWithTimeout(
              API_ENDPOINT,
              {
                method: "POST",
                headers: { "content-type": "application/json" },
                body: JSON.stringify({ isbns: chunk })
              },
              CHUNK_TIMEOUT_MS
            );
          } catch (e) {
            // íƒ€ì„ì•„ì›ƒ/ì—°ê²° ì‹¤íŒ¨: ì´ chunkëŠ” í–‰ ë‹¨ìœ„ ì‹¤íŒ¨ë¡œ ê¸°ë¡í•˜ê³  ê³„ì† ì§„í–‰
            const reason = `ìš”ì²­ ì‹œê°„ ì´ˆê³¼/ì—°ê²° ì‹¤íŒ¨(í”„ë¡ íŠ¸): ${String(e?.name || e).slice(0, 80)}`;
            lastResults = lastResults.concat(chunk.map(isbn => makeFailRow(isbn, reason)));
            runningSummary = addSummary(runningSummary, {
              total: chunk.length, success: 0, notFound: 0, failed: chunk.length, invalid: 0
            });
            doneCount += chunk.length;
            renderTable(lastResults);
            renderSummary(runningSummary);
            continue;
          }

          const data = await readJsonSafely(res);

          if (!res.ok || !data?.ok) {
            // ì„œë²„ê°€ 4xx/5xx ë˜ëŠ” data.ok=false: ì´ chunk ì „ì²´ë¥¼ ì‹¤íŒ¨ë¡œ ê¸°ë¡í•˜ê³  ê³„ì†
            const reason = `ì„œë²„ ì˜¤ë¥˜: ${data?.error || `HTTP ${res.status}`}`;
            lastResults = lastResults.concat(chunk.map(isbn => makeFailRow(isbn, reason)));
            runningSummary = addSummary(runningSummary, {
              total: chunk.length, success: 0, notFound: 0, failed: chunk.length, invalid: 0
            });
            doneCount += chunk.length;
            renderTable(lastResults);
            renderSummary(runningSummary);
            continue;
          }

          const rows = Array.isArray(data.results) ? data.results : [];
          lastResults = lastResults.concat(rows);

          // summaryëŠ” ì„œë²„ê°€ ì¤€ ê²ƒì„ ëˆ„ì  (ì—†ìœ¼ë©´ ê²°ê³¼ë¡œ ì¶”ì •)
          if (data.summary) {
            runningSummary = addSummary(runningSummary, data.summary);
          } else {
            // ì¶”ì •(ë³´ìˆ˜)
            const s = {
              total: rows.length,
              success: rows.filter(r => r["ì¡°íšŒê²°ê³¼"] === "ì„±ê³µ").length,
              notFound: rows.filter(r => r["ì¡°íšŒê²°ê³¼"] === "ë¯¸ê²€ìƒ‰").length,
              failed: rows.filter(r => r["ì¡°íšŒê²°ê³¼"] === "ì‹¤íŒ¨").length,
              invalid: rows.filter(r => r["ì¡°íšŒê²°ê³¼"] === "í˜•ì‹ì˜¤ë¥˜").length,
            };
            runningSummary = addSummary(runningSummary, s);
          }

          doneCount += chunk.length;

          // ì¤‘ê°„ ë Œë”ë§(ì‚¬ìš©ì ì²´ê° ê°œì„ )
          renderTable(lastResults);
          renderSummary(runningSummary);
        }

        elProgress.textContent = "ì™„ë£Œ";
        elDetail.textContent = `ì™„ë£Œ: ${doneCount}/${all.length} ì²˜ë¦¬ë¨`;
        btnDownload.disabled = lastResults.length === 0;

        enableRetryButton();
      } catch (e) {
        elProgress.textContent = "ì˜¤ë¥˜";
        alert(`ì¡°íšŒ ì‹¤íŒ¨: ${e?.message || e}`);
      } finally {
        isRunning = false;
        btnLookup.disabled = false;
        btnClear.disabled = false;
      }
    });

    // âœ… ë¯¸ê²€ìƒ‰ë§Œ ì¬ì¡°íšŒ: "ë®ì–´ì“°ê¸°"ë¡œ ìˆœì„œ ìœ ì§€
    btnRetryNotFound.addEventListener("click", async () => {
      if (isRunning) return;

      // ë¯¸ê²€ìƒ‰ ëŒ€ìƒ + ì¸ë±ìŠ¤ ìˆ˜ì§‘
      const targets = [];
      lastResults.forEach((row, index) => {
        if (row["ì¡°íšŒê²°ê³¼"] === "ë¯¸ê²€ìƒ‰") {
          targets.push({ isbn: row.isbn, index });
        }
      });

      if (targets.length === 0) {
        alert("ë¯¸ê²€ìƒ‰ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.");
        btnRetryNotFound.disabled = true;
        return;
      }

      isRunning = true;
      btnLookup.disabled = true;
      btnRetryNotFound.disabled = true;
      btnDownload.disabled = true;
      btnClear.disabled = true;

      const retryIsbns = targets.map(t => t.isbn);
      const chunks = chunkArray(retryIsbns, CHUNK_SIZE);

      let processed = 0;

      try {
        for (let ci = 0; ci < chunks.length; ci++) {
          elProgress.textContent = `ë¯¸ê²€ìƒ‰ ì¬ì¡°íšŒ ì¤‘... (${processed}/${targets.length})`;
          elDetail.textContent = `ë¯¸ê²€ìƒ‰ ì¬ì¡°íšŒ ì§„í–‰: ${processed}/${targets.length}`;

          let res;
          try {
            res = await fetchWithTimeout(
              API_ENDPOINT,
              {
                method: "POST",
                headers: { "content-type": "application/json" },
                body: JSON.stringify({ isbns: chunks[ci] })
              },
              CHUNK_TIMEOUT_MS
            );
          } catch {
            // ì´ chunkëŠ” ì‹¤íŒ¨ë¡œë§Œ ë‚¨ê¸°ê³  ë‹¤ìŒ ì§„í–‰ (ìˆœì„œ ìœ ì§€)
            processed += chunks[ci].length;
            continue;
          }

          const data = await readJsonSafely(res);
          if (!res.ok || !data?.ok || !Array.isArray(data.results)) {
            processed += chunks[ci].length;
            continue;
          }

          // ğŸ”¥ ë®ì–´ì“°ê¸°: lastResultsì˜ "í•´ë‹¹ ì¸ë±ìŠ¤"ë¥¼ êµì²´ (ìˆœì„œ 100% ìœ ì§€)
          data.results.forEach(newRow => {
            const t = targets.find(
              x => x.isbn === newRow.isbn && lastResults[x.index]["ì¡°íšŒê²°ê³¼"] === "ë¯¸ê²€ìƒ‰"
            );
            if (!t) return;
            lastResults[t.index] = newRow;
          });

          processed += chunks[ci].length;

          // ì¦‰ì‹œ ë°˜ì˜
          renderTable(lastResults);
        }

        elProgress.textContent = "ë¯¸ê²€ìƒ‰ ì¬ì¡°íšŒ ì™„ë£Œ";
        elDetail.textContent = `ë¯¸ê²€ìƒ‰ ì¬ì¡°íšŒ ì™„ë£Œ: ${targets.length}ê±´`;
        btnDownload.disabled = lastResults.length === 0;

        enableRetryButton();
      } finally {
        isRunning = false;
        btnLookup.disabled = false;
        btnClear.disabled = false;
        btnDownload.disabled = lastResults.length === 0;
      }
    });

    btnDownload.addEventListener("click", () => {
      if (!lastResults || lastResults.length === 0) return;

      const cols = ["isbn","ë„ì„œëª…","ì €ìëª…","ë„ì„œëª…(ì €ìëª…)","ì¶œíŒì‚¬","ë°œí–‰ë…„ë„","ì¡°íšŒê²°ê³¼","ë¹„ê³ "];
      const rows = lastResults.map(r => {
        const o = {};
        for (const c of cols) o[c] = r?.[c] ?? "";
        return o;
      });

      const ws = XLSX.utils.json_to_sheet(rows, { header: cols });
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "ê²°ê³¼");

      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, "0");
      const dd = String(today.getDate()).padStart(2, "0");
      XLSX.writeFile(wb, `isbn_ë„ì„œëª©ë¡_${yyyy}-${mm}-${dd}.xlsx`);
    });

    btnClear.addEventListener("click", () => {
      if (isRunning) return;
      elInput.value = "";
      updateCount();
      lastResults = [];
      renderTable([]);
      renderSummary(null);
      elDetail.textContent = "";
      btnDownload.disabled = true;
      btnRetryNotFound.disabled = true;
      elProgress.textContent = "ëŒ€ê¸°";
    });
  </script>
</body>
</html>
